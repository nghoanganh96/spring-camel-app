# Getting Started

## 1. Prerequisites

### Environments
* Java 19, Maven

### Tạo Database: 
* Mysql 8, Db2
* Kết nối DB: config trong application.yml: spring.jta.atomikos.datasource (server name, port, username, password ...). Đối với Mysql, nên tạo schema trước. 
* Store procedures: in /resources/storeprocedures/db2-script.sql and mysql-script.sql, mỗi script có 3 store procedures: add new record, get by id, get all.

### Library used
* Apache camel, ActiveMQ, spring data jpa, atomikos (manage global transaction in spring)...

## 2. Configuration

### Database
* Cách 1: Nếu DB chưa có gì, muốn tạo data structure (table, column ...) ở DB -> sửa ở application.yml: 
    `spring.jta.atomikos.datasource.mysql-user.hbm2ddl-auto: create`
    `spring.jta.atomikos.datasource.db2-card.hbm2ddl-auto: create`
* Ở lần run sau thì nên chỉ định giá trị đó là empty, vd: `spring.jta.atomikos.datasource.db2-card.hbm2ddl-auto: `
* Cách 2: run trực tiếp script sql
  - a/ DB2
    ```sql
    create table DB2INST1.CARD_INFORMATION
      (
          ID            BIGINT generated by default as identity
          primary key,
          CREATED_DATE  TIMESTAMP(6) not null,
          MODIFIED_DATE TIMESTAMP(6),
          CARD_NUMBER   VARCHAR(255),
          CARD_TYPE     VARCHAR(255),
          CIF_ID        VARCHAR(255),
          CUST_NAME     VARCHAR(255),
          UUID          VARCHAR(255)
      );
    ```
  - b/ Mysql

    ```sql
    create table user.User
      (
          id        bigint auto_increment
          primary key,
          cif_id    varchar(255) null,
          more_info varchar(255) null
      );
    ```
  
### Application

#### Description:
1. Sử dụng apache camel để quản lý Router 
2. Sử dụng Spring-data-jpa để kết nối DB
3. Camel Route sẽ gọi các service đang dùng jpa để tương tác với DB (thông qua Store procedures)
4. Atomikos Jta để quản lý transaction (global transaction: 2 databases và 1 activeMQ trong các camel route)

#### Routers:
1. Insert 1 record cho User (Mysql) và 1 record cho CardInfomation (Db2)
   - Controller rest api -> send Request message to ActiveMQ -> Camel processing to save data.... -> send Response to another queue on ActiveMQ
   - Check kết quả ở activemq (queue:anhnh.spring.sp.addcarduser.response) và database
   - Example start controller:

    ```url
    curl --location --request POST 'localhost:8081/app/v1/card-info/addcarduser' \
       --header 'Content-Type: application/json' \
       --data-raw '{
       "cifId": "112",
       "moreInfo": "some information",
       "cardNumber": "1111 1112",
       "cardType": "A",
       "custName": "NGUYEN VAN A"
       }'
    ```

2. Như route 1, nhưng sẽ throw exception để rollback ở database và không lưu response ở queue
   - Để kiểm tra global transaction hoạt động trên nhiều resource (2 databases và 1 activeMQ).
   - Controller rest api -> send Request message to ActiveMQ -> Camel processing to save data .... -> send Response to another queue on ActiveMQ -> throw exception -> rollback DB and queue
   - Example start controller:

    ```url
    curl --location --request POST 'localhost:8081/app/v1/card-info/addcarduser/error' \
       --header 'Content-Type: application/json' \
       --data-raw '{
       "cifId": "108",
       "moreInfo": "some information 2",
       "cardNumber": "1111 1118",
       "cardType": "B",
       "custName": "NGUYEN VAN B"
       }'
    ```

3. Delete record ở User (Mysql) dựa vào userId và CardInfomation (Db2) (linked bằng cifId)
    - Controller rest api -> send Request message to ActiveMQ -> Camel processing to delete User -> Camel processing to delete CardInfo -> send Response to another queue on ActiveMQ
    - Check kết quả ở activemq (queue:anhnh.spring.sp.deletecarduser.response) và database
    - Example start controller:

    ```url
    curl --location --request DELETE 'localhost:8081/app/v1/card-info/deletecarduser/1'
    ```

4. Như route 3, nhưng sẽ throw exception để rollback ở database và không lưu response ở queue
    - Để kiểm tra global transaction hoạt động trên nhiều resource (2 databases và 1 activeMQ).
    - Controller rest api -> send Request message to ActiveMQ -> Camel processing to delete User -> Camel processing to delete CardInfo -> send Response to another queue on ActiveMQ -> throw exception -> rollback DB and queue
    - Example start controller:

    ```url
    curl --location --request DELETE 'localhost:8081/app/v1/card-info/deletecarduser/error/2'
    ```
   
5. Get one card information by id
   - Controller rest api -> Camel processing to get data .... -> return the response in rest api
   - Example start controller:

    ```url
    curl --location --request GET 'localhost:8081/app/v1/card-info/1'
    ```
6. Get all card information
   - Controller rest api  -> Camel processing to get data .... -> return the response in rest api
   - Example start controller:

   ```url
     curl --location --request GET 'localhost:8081/app/v1/card-info/all'
   ```